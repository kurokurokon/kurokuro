<!doctype html>
<html>
<head>
  <title>Kurokuro - くろくろ</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
	body{
		background-color:rgb(10,10,10);
		color:#eee;
		font-family:'微软雅黑';
	}
	#logo img{
		height:32px;
	}
	#footer {
position: fixed;
background-color:rgba(0,0,0,0.8);
bottom: 0px;
}
	.listdata,.list_close,#search,#taglist{
		-webkit-transition:all .6s ease-in-out;
		-moz-transition:all .6s ease-in-out;
		-ms-transition:all .6s ease-in-out;
		-o-transition:all .6s ease-in-out;
		transition:all .6s ease-in-out;
	}
	.list_img{
		width:64px;
		height:64px;
		border-radius:5px;
		padding:5px;
		background-color:rgb(230,230,230);
		border:solid 2px rgba(255,255,255,0.5)
	}
	#logo{
		font-size: 36px;
		position:absolute;
		top:10px;
		left:10px;
	}
	#menu{
		font-size: 24px;
		position:absolute;
		top:10px;
		right:10px;
	}
	#menu div{
		width:200px;
		text-align:center;
		cursor:pointer;
		margin:0 20px 0 20px;
	}
	#menu div{
		width:200px;
		text-align:center;
		cursor:pointer;
		border-radius:10px;
		display:inline-block;
	}
	#menu div:hover{
		color:rgb(10,10,10);
		background-color:rgb(230,230,230);
	}
	#box{
		position:absolute;
		top:80px;
		left:10px;
		right:10px;
	}
	.listdata{
		border-radius:10px;
		background-color:rgba(255,255,255,0.1);
		width:100%;
		height:120px;
		margin-top:20px;
		border:solid 2px rgba(255,255,255,0.3);
		overflow:hidden;
	}
	.list_head{
		height:120px;
	}
	.list_img{
		margin-top:20px;
		margin-left:20px;
	}
	.list_datas {
		margin-top: -80px;
		margin-left: 150px;
	}
	.list_name{
		font-size: 24px;
	}
	.list_time{
		margin-top:15px;
	}
	.list_size{
		float:right;
		margin-right:50px;
		margin-top:-40px;
		font-size: 24px;
	}
	.list_res_btn{
		display:inline-block;
		background-color:rgba(255,255,255,0.1);
		border:solid 2px rgba(255,255,255,0.3);
		border-radius:5px;
		padding:2px 10px;
		cursor:pointer;
	}
	.list_res{
		background-color:rgba(255,255,255,0.1);
		margin:20px;
		padding:20px;
	}
	.list_res_list{
		padding:10px;
		background-color:rgba(255,255,255,0.1);
		margin:20px;
		height:250px;
		overflow-y: scroll;
	}
	.list_res_item div{
		display:inline-block;
	}
	.list_res_item{
		padding:5px;
		cursor:pointer;
	}
	.list_res_item:hover{
		opacity:0.8;
	}
	.list_res_item_selected{
		background-color:rgba(255,255,255,0.7); !important;
		color:#444 !important;
	}
	.list_res_item_selected:nth-child(2n-1){
		background-color:rgba(255,255,255,0.9); !important;
		color:#444 !important;
	}
	.list_res_item:nth-child(2n-1){
		background-color:rgba(255,255,255,0.6);
	}
	.list_res_item_size{
		float:right;
		margin-right:10px;
	}
	.list_res_item_num{
		min-width:20px;
	}
	.list_res_des{
		height:150px;
		background-color:rgba(255,255,255,0.1);
		margin:20px;
		padding:20px;
		overflow-y: scroll;
	}
	.list_close{
		float:right;
		margin-right: 20px;
margin-top: 20px;
background-color:rgba(255,255,255,0.1);
padding: 5px 20px;
border-radius: 5px 5px 0px 0px;
	cursor:pointer;
		opacity:0;
	}
	.list_unfold .list_close{
		opacity:1;
	}
	#page_list{
		width:100%;
		text-align:center;
		margin-top:20px;
		font-size:24px;
		
	}
	#page_list div{
		display:inline-block;
		padding:5PX;
	}
	.page_list_btn,.page_list_num{
		cursor:pointer;
	}
	.page_list_now,.page_list_num:hover,.page_list_btn:hover{
		background-color:rgba(255,255,255,0.15);
		border-radius:5px;
	}
	#group_dl_box {
		position: fixed;
		background-color: rgb(250,250,250);
		padding: 30px;
		color: #444;
		border-radius: 5px;
		top: 40%;
		left: 35%;
		height: 100px;
		width: 350px;
		display:none;
	}
	#group_dl_box_close{
		float:right;
		color:#eee;
	}
	#group_dl_box_val {
		width: 100%;
		height: 60px;
		resize: none;
		border-radius: 5px;
		border: solid 1px #ccc;
		font-family: '微软雅黑';
		color: #444;
	}
	.list_res_item_other a {
		text-decoration: none;
		color: #eee;
		background-color: rgba(255,255,255,0.1);
		padding: 2px;
	}
	.list_res_item_other a:hover {
		opacity: 0.8;
	}
	.list_body{
		background-image:url(kuro_big.png);
		background-repeat:no-repeat;
		background-position:bottom left;
	}
	.list_res_tips {
		display: inline-block;
		margin-left: 50px;
	}
	#search,#taglist{
		height:0px;
		overflow:hidden;
		background-color: rgba(255,255,255,0.2);
		text-align: center;
	}
	#search_t {
		padding: 5px;
		margin: 5px;
		border: solid 1px #666;
		border-radius: 5px;
		font-size: 16px;
		width: 30%;
		outline:none;
	}
	.list_res_tags {
margin: 2px 20px;
}
.list_res_tags div,#taglist_list div{
display: inline-block;
background-color: rgba(255,255,255,0.2);
cursor:pointer;
padding: 5px;
}#taglist_list div{
margin: 10px;
}
.list_res_tags div:hover,#taglist_list div:hover{
background-color: rgba(255,255,255,0.1);
}
  </style>
</head>
<body ondragstart="return false;">
<div id="header">
	<div id="logo"><img src="shiro.gif">Kurokuro</div>
	<div id="menu">
		<div id="menu_main">Main</div>
		<div id="menu_search">Search</div>
		<div id="menu_tags">Tags</div>
	</div>
</div>
<div id="box">
	<div id="bar">
    	<div id="search">
        	<input id="search_t" type="text" placeholder="输关键字搜索,以后绝对不能搜番号的噗~~">
            <div id="go_search" class="list_res_btn" onclick="search_word(document.getElementById('search_t').value)">噗~</div>
        </div>
        <div id="taglist">
        	<center style="font-size: 24px;">下面是各种的tag的嗦~~&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<div class="list_res_btn" onclick="close_tag_list();">关闭</div></center>
            
        	<div id="taglist_list">
        		loading...
            </div>
        </div>
    </div>
	<div id="list"></div>
	<div id="page_list"></div>
    <div id="group_dl_box">
    	<center>请复制下载链接:</center>
        <textarea id="group_dl_box_val"></textarea>
        <div id="group_dl_box_close" style="background:#444;" class="list_res_btn" onclick="document.getElementById('group_dl_box').style.display='none'">关闭</div>
    </div>
</div>
<div id="footer">
	view on github
<div style="font-size:16px;margin:0 auto;width:300px;display:inline-block;" class="blockchain-btn"
     data-address="1J5j6Uf5qsKFjSvjr9ouVqxp3gKJ8t1N2B"
     data-shared="false">
    <div class="blockchain stage-begin">
        <img src="https://blockchain.info//Resources/buttons/donate_64.png" style="width: 40%;"/>
    </div>
    <div class="blockchain stage-loading" style="text-align:center">
        <img src="https://blockchain.info//Resources/loading-large.gif"  style="width: 40%;"/>
    </div>
    <div class="blockchain stage-ready">
         <p align="center">Please Donate To Bitcoin Address: <b>[[address]]</b></p>
         <p align="center" class="qr-code"></p>
    </div>
    <div class="blockchain stage-paid">
         Donation of <b>[[value]] BTC</b> Received. Thank You.
    </div>
    <div class="blockchain stage-error">
        <font color="red">[[error]]</font>
    </div>
</div>
</div>
<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript" src="https://blockchain.info//Resources/wallet/pay-now-button.js"></script>

<script>
function GETDATA(api,data,sc,err){
	$.ajax({
                 type:"GET",
                dataType:"jsonp",
                 url:"http://kurokuro.mb"+api,
				 data:data,
                 timeout:100000,   
                 success:function (data,textStatus) {
           		if(sc) {
             			sc(data);
           		}
           		return data;
                   
              	},error:function (XMLHttpRequest,textStatus,errorThrown) {
            		if(err) {
             			err();
           		}
            		return -1;
               }
                 
   	});
}

function mutilstring(f,vals) {　
    var rhtml = f.toString().replace(/^[^\/]+\/\*!?\s?/, '').replace(/\*\/[^\/]+$/, '');
  
    rhtml = rhtml.replace(/\%\$([0-9])*\%/g, function (match) {
      var r = match.replace(/\%/g,'');
      r = parseInt(r.replace(/\$/g,''));
      if(r&&vals&&typeof(vals[r-1])!== "undefined") {
        return vals[r-1];
      }else{
        console.error({
          err:"can't find "+match,
          where:f
        });
      }
          return match;
      
      });
  return rhtml;
}
function add_node(datas,cover_ba64,title,add_time,update_time,total_size,des,tag){
	var dldatas='';
	for(var i=0;i<datas.length;i++){
		var other='';
		var ftype=((datas[i].name).split(".").pop()).toUpperCase();
		var vtypes=["AVI","MKV","RM","RMVB","FLV","BDMV","WMV","3GP","MP4","MPG","MPEG"];
		if((datas[i].type==1||datas[i].type==3)&&vtypes.indexOf(ftype)!=-1){
			other=other+'<a href="http://vod.xunlei.com/share.html?url='+datas[i].data+'" target="_blank">云播</a>'
		}
		if(datas[i].type==1&&vtypes.indexOf(ftype)!=-1){
			other=other+'<a href="http://vod.qq.com/?ed2k='+datas[i].data+'" target="_blank">旋播</a>'
		}
		if((datas[i].type==1||datas[i].type==3)){
			other=other+'<a href="http://lixian.vip.xunlei.com/lixian_login.html?furl='+datas[i].data+'&s=&f=undefined" target="_blank">离线</a>'
		}
		if((datas[i].type==1||datas[i].type==3)&&vtypes.indexOf(ftype)!=-1){
			other=other+'<a href="http://www.30405.com/player.php?url='+datas[i].data+'" target="_blank">盗播</a>'
		}
		dldatas=dldatas+mutilstring(function(){/*
			<div class="list_res_item" onclick="select_dl(this);" datalink="%$1%">
				<div class="list_res_item_num">%$3%.</div>
				<div class="list_res_item_name">%$2%</div>
				<div class="list_res_item_other">%$5%</div>
				<div class="list_res_item_size">%$4%</div>
			</div>
		*/},[datas[i].data,datas[i].name,(i+1),datas[i].size,other])
	}
	var tags='';
	if(tag){
	for(var i=0;i<tag.length;i++){
		tags=tags+mutilstring(function(){/*
			<div onclick="search_tag(%$2%)">%$1%</div>
		*/},[tag[i].name,tag[i].id])
	}
	}
	return mutilstring(function(){/*
		<div class="listdata" onclick="show_unfold(this);">
			<div class="list_head">
				<img src="%$1%" class="list_img">
				<div class="list_datas">
					<div class="list_name">%$2%</div>
					<div class="list_time">发布时间:%$3% 更新时间: %$4%</div>
				</div>
                <div class="list_close" onclick="show_fold(this);">关闭</div>
				<div class="list_size">%$5%</div>
			</div>
			<div class="list_body">
				<div class="list_res">
					<div class="list_res_top">
						<div class="list_res_btn" onclick="select_all(this);">select all</div>
						<div class="list_res_btn" onclick="unselect_all(this);">unselect all</div>
						<div class="list_res_btn"  onclick="dl_all(this);">download</div>
						
					</div>
					<div class="list_res_list">
						%$6%
					</div>
				</div>
                <div class="list_res_des">
                	%$7%
                </div>
				<div class="list_res_tags">
                	%$8%
                </div>
			</div>
		</div>
	*/},[cover_ba64,title,add_time,update_time,total_size,dldatas,des,tags]);
}
MAX_PAGE=1;
CACHED_DATAS=new Array;
function parse_page(page){
	if(page<1||page>MAX_PAGE){
		return;
	}
	document.getElementById('list').innerHTML="Loading...";
	var parsenodes=function(datas){
		var opt='';
		if(page>1){
			opt=opt+'<div class="page_list_btn" onclick="parse_page('+(page-1)+')"><</div>';
			opt=opt+'<div class="page_list_btn" onclick="parse_page(1)">1</div>';
			if(page-3>0){
				opt=opt+'<div class="page_list_num2">...</div>';
				opt=opt+'<div class="page_list_num" onclick="parse_page('+(page-1)+')">'+(page-1)+'</div>';
			}else{
				if(page-2>0){
					opt=opt+'<div class="page_list_num" onclick="parse_page(2)">2</div>';
				}
			}					
		}
		opt=opt+'<div class="page_list_num2" onclick="parse_page('+(page)+')" style="font-size:26px;">'+(page)+'</div>';
		if(page+1<=MAX_PAGE){
			if(page<MAX_PAGE-1){
				opt=opt+'<div class="page_list_num" onclick="parse_page('+(page+1)+')">'+(page+1)+'</div>';
			}
			if(page+3<=MAX_PAGE){
				opt=opt+'<div class="page_list_num2">...</div>';
			}
			opt=opt+'<div class="page_list_num" onclick="parse_page('+(MAX_PAGE)+')">'+(MAX_PAGE)+'</div>';
			opt=opt+'<div class="page_list_num" onclick="parse_page('+(page+1)+')">></div>';
		}
		document.getElementById("page_list").innerHTML=opt;
		opt="";
		for(var i=0;i<datas.length;i++){
			opt=opt+add_node(datas[i].res,datas[i].cover,datas[i].name,datas[i].add_time,datas[i].update_time,datas[i].size,datas[i].content,datas[i].tag);
		}
		document.getElementById('list').innerHTML=opt;
	}
	if(CACHED_DATAS[page-1]){
		parsenodes(CACHED_DATAS[page-1]);
	}else{
		if(!SEARCH_WORD&&!SEARCH_TAG){
			GETDATA("/api/list",{limit:5,offset:page},function(data){
				MAX_PAGE=(data.datas.total_num)/5;
				MAX_PAGE=(MAX_PAGE==parseInt(MAX_PAGE))?MAX_PAGE:(parseInt(MAX_PAGE)+1);
				CACHED_DATAS[page-1]=data.datas.datas;
				parsenodes(CACHED_DATAS[page-1]);
			},function(e){
				console.log(e);
			})
		}else if(SEARCH_WORD){
			GETDATA("/api/search",{limit:5,offset:page,keywords:SEARCH_WORD},function(data){
				MAX_PAGE=(data.datas.total_num)/5;
				MAX_PAGE=(MAX_PAGE==parseInt(MAX_PAGE))?MAX_PAGE:(parseInt(MAX_PAGE)+1);
				CACHED_DATAS[page-1]=data.datas.datas;
				parsenodes(CACHED_DATAS[page-1]);
			},function(e){
				console.log(e);
			})
		}else if(SEARCH_TAG){
			GETDATA("/api/search",{limit:5,offset:page,tagid:SEARCH_TAG},function(data){
				MAX_PAGE=(data.datas.total_num)/5;
				MAX_PAGE=(MAX_PAGE==parseInt(MAX_PAGE))?MAX_PAGE:(parseInt(MAX_PAGE)+1);
				CACHED_DATAS[page-1]=data.datas.datas;
				parsenodes(CACHED_DATAS[page-1]);
			},function(e){
				console.log(e);
			})
		}
	}
}
SEARCH_WORD=0;
SEARCH_TAG=0;
parse_page(1);


function search_word(word){
	if(!word){
		return;
	}
	SEARCH_WORD=word;
	SEARCH_TAG=0;
	MAX_PAGE=1;
	CACHED_DATAS=new Array;
	parse_page(1);
}
function search_tag(tagid){
	close_tag_list();
	SEARCH_WORD=0;
	SEARCH_TAG=tagid;
	MAX_PAGE=1;
	CACHED_DATAS=new Array;
	parse_page(1);
}
function show_all_tags(){
	document.getElementById('taglist_list').innerHTML="Loading...";
	GETDATA("/api/tags",{limit:100},function(data){
		var opt='';
		var tag=data;
		for(var i=0;i<tag.length;i++){
			opt=opt+mutilstring(function(){/*
				<div onclick="search_tag(%$2%)">%$1% (%$3%)</div>
			*/},[tag[i].name,tag[i].id,tag[i].count])
		}
		document.getElementById('taglist_list').innerHTML=opt;
	},function(e){
		console.log(e);
	})
}
var locker=0;
function show_unfold(node){
	if(!locker&&(!node.className||node.className!="listdata list_unfold")){
		node.className="listdata list_unfold";
		node.style.height="800px";
	}
}
function show_fold(node){
	var $node=node.parentNode.parentNode;
	console.log($node)
		$node.className="listdata";
		$node.style.height="120px";
		locker=1;
		setTimeout("locker=0;",600);
}
function select_dl(node){
	var dlbtn=node.parentNode.parentNode.childNodes[1].childNodes[5];
	if(!dlbtn.dllist){
		dlbtn.dllist=new Array;
	}
	if(!node.className||node.className!="list_res_item list_res_item_selected"){
		node.className="list_res_item list_res_item_selected";
		if(dlbtn.dllist.indexOf(node)==-1){
			dlbtn.dllist.push(node);
		}
	}else{
		node.className="list_res_item";
		if(dlbtn.dllist.indexOf(node)!=-1){
			dlbtn.dllist.splice(dlbtn.dllist.indexOf(node),1);
		}
	}
	console.log(dlbtn.dllist);
	
}
function select_all(node){
	var nodes=node.parentNode.nextSibling.nextSibling.childNodes;
	for(var i=0;i<nodes.length;i++){
		var node=nodes[i];
		if(node.tagName){
		if(!node.className||node.className!="list_res_item list_res_item_selected"){
			select_dl(node);
		}
		}
	}
}
function unselect_all(node){
	var nodes=node.parentNode.nextSibling.nextSibling.childNodes;
	for(var i=0;i<nodes.length;i++){
		var node=nodes[i];
		if(node.className&&node.className=="list_res_item list_res_item_selected"){
			select_dl(node);
		}
	}
}
function dl_all(node){
	var list=node.dllist;
	if(!list||list.length==0){
		alert("请选择至少一个文件")
		return;
	}
	var dlist="";
	for(var i=0;i<list.length;i++){
		dlist=dlist+list[i].getAttribute("datalink")+"\n";
	}
	document.getElementById('group_dl_box_val').value=dlist;
	document.getElementById('group_dl_box').style.display='block';
	document.getElementById('group_dl_box_val').select();
}
document.getElementById('menu_search').addEventListener("click",function(){
	document.getElementById('search').style.height="40px";
},false);
document.getElementById('menu_main').addEventListener("click",function(){
	document.getElementById('search').style.height="0px";
	close_tag_list();
	parse_page(1);
},false);
function close_tag_list(){
	document.getElementById('taglist').style.height="0px";
}
document.getElementById('menu_tags').addEventListener("click",function(){
	document.getElementById('taglist').style.height="600px";
	show_all_tags();
},false);

</script>
</body>
</html>

